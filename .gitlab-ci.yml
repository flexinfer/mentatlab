stages:
  - lint
  - test
  - build

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: registry.harbor.lan/library

# --- Linting ---

lint-go:
  stage: lint
  image: golang:1.23-alpine
  script:
    - go vet ./services/gateway-go/...
    - go vet ./services/orchestrator-go/...

lint-frontend:
  stage: lint
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm run lint

# --- Testing ---

test-go:
  stage: test
  image: golang:1.23-alpine
  script:
    - go test -v ./services/gateway-go/...
    - go test -v ./services/orchestrator-go/...

test-frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm test

# --- Build ---

# Note: This requires a runner with Docker access (e.g., shell executor or dind service)
build-images:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    # Login to registry if needed. Assuming insecure/internal for now based on user context.
    # - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $REGISTRY
  script:
    - apk add --no-cache bash curl
    - ./build-and-push.sh --registry $REGISTRY --skip-push # Just build for now to verify
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
