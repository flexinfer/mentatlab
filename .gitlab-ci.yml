stages:
  - lint
  - test
  - build

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: registry.harbor.lan/library

# --- Linting ---

lint-go:
  stage: lint
  image: golang:1.23-alpine
  script:
    - (cd services/gateway-go && go vet ./...)
    - (cd services/orchestrator-go && go vet ./...)

lint-frontend:
  stage: lint
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm run lint

# --- Testing ---

test-go:
  stage: test
  image: golang:1.23-alpine
  script:
    - (cd services/gateway-go && go test -v ./...)
    - (cd services/orchestrator-go && go test -v ./...)

test-frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm test

# --- Build ---

# Note: This requires a runner with Docker access (e.g., shell executor or dind service)
build-images:
  stage: build
  image: docker:latest
  services:
    - docker:dind

  script:
    - apk add --no-cache bash curl
    - ./build-and-push.sh --registry $REGISTRY --skip-push # Just build for now to verify
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
