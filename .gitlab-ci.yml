stages:
  - lint
  - test
  - build

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: registry.harbor.lan/library

# --- Linting ---

lint-python:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install flake8
    - flake8 services/orchestrator services/gateway services/agents/echo

lint-frontend:
  stage: lint
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm run lint

# --- Testing ---

test-orchestrator:
  stage: test
  image: python:3.11-slim
  script:
    - cd services/orchestrator
    - pip install -r requirements.txt
    - pip install pytest
    - pytest

test-gateway:
  stage: test
  image: python:3.11-slim
  script:
    - cd services/gateway
    - pip install -r requirements.txt
    - pip install pytest
    - pytest

test-frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm test

# --- Build ---

# Note: This requires a runner with Docker access (e.g., shell executor or dind service)
build-images:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    # Login to registry if needed. Assuming insecure/internal for now based on user context.
    # - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $REGISTRY
  script:
    - apk add --no-cache bash curl
    - ./build-and-push.sh --registry $REGISTRY --skip-push # Just build for now to verify
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
