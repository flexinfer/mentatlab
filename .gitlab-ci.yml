include:
  - project: platform/gitops
    ref: main
    file:
      - /k3s/ci/caches/gitlab-ci-cache.yml

stages:
  - lint
  - test
  - build
  - deploy

variables:
  REGISTRY: registry.harbor.lan/library
  BUILDKIT_HOST: "tcp://buildkitd-central.ci-build.svc.cluster.local:1234"

# --- Linting ---

lint-go:
  stage: lint
  image: golang:1.24-alpine
  script:
    - (cd services/gateway-go && go vet ./...)
    - (cd services/orchestrator-go && go vet ./...)

lint-frontend:
  stage: lint
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm run lint

# --- Testing ---

test-go:
  stage: test
  image: golang:1.24-alpine
  script:
    - (cd services/gateway-go && go test -v ./...)
    - (cd services/orchestrator-go && go test -v ./...)

test-frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm test

# --- Build ---

# Build images via BuildKit (no Docker-in-Docker)
build-images:
  stage: build
  image: moby/buildkit:v0.12.5
  script:
    - |
      echo "Waiting for BuildKit..."
      for i in $(seq 1 30); do
        if buildctl --addr "${BUILDKIT_HOST}" debug info >/dev/null 2>&1; then
          echo "BuildKit is ready"; break
        fi
        echo "[$i/30] not ready yet"; sleep 2
      done
      buildctl --addr "${BUILDKIT_HOST}" debug info
    - |
      REGISTRY_TARGET="${REGISTRY}"
      build_image() {
        local name="$1" context="$2"
        buildctl --addr "${BUILDKIT_HOST}" build \
          --frontend dockerfile.v0 \
          --local context="${context}" \
          --local dockerfile="${context}" \
          --opt platform=linux/amd64 \
          --output "type=image,push=true,name=${REGISTRY_TARGET}/${name}:latest,name=${REGISTRY_TARGET}/${name}:${CI_COMMIT_SHORT_SHA}"
      }

      build_image "mentatlab-orchestrator-go" "services/orchestrator-go"
      build_image "mentatlab-gateway-go" "services/gateway-go"
      build_image "mentatlab-frontend" "services/frontend"
      build_image "mentatlab-echoagent" "services/agents/echo"
      build_image "mentatlab-psyche-sim" "agents/psyche-sim"
      build_image "mentatlab-ctm-cogpack" "agents/ctm-cogpack"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# --- E2E Testing ---

e2e-test:
  stage: test
  image: docker:24-cli
  services:
    - name: docker:24-dind
      alias: docker
      # Command to start with no TLS (secure within K8s pod)
      command: ["--tls=false"]
  variables:
    # Use non-TLS connection for K8s-based runners
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    # Use built images from registry
    ORCHESTRATOR_IMAGE: "${REGISTRY}/mentatlab-orchestrator-go:${CI_COMMIT_SHORT_SHA}"
    GATEWAY_IMAGE: "${REGISTRY}/mentatlab-gateway-go:${CI_COMMIT_SHORT_SHA}"
    FRONTEND_IMAGE: "${REGISTRY}/mentatlab-frontend:${CI_COMMIT_SHORT_SHA}"
  before_script:
    - apk add --no-cache docker-compose curl jq
    # Wait for Docker daemon to be ready
    - |
      echo "Waiting for Docker daemon..."
      for i in $(seq 1 30); do
        if docker info >/dev/null 2>&1; then
          echo "Docker daemon ready"
          break
        fi
        echo "[$i/30] Docker not ready yet..."
        sleep 2
      done
    - docker info
  script:
    - |
      echo "=== Starting E2E Tests ==="

      # Create docker-compose override for CI
      cat > docker-compose.ci.yml << 'EOF'
      version: '3.9'
      services:
        orchestrator:
          image: ${ORCHESTRATOR_IMAGE:-registry.harbor.lan/library/mentatlab-orchestrator-go:latest}
          build: !reset null
        gateway:
          image: ${GATEWAY_IMAGE:-registry.harbor.lan/library/mentatlab-gateway-go:latest}
          build: !reset null
        frontend:
          image: ${FRONTEND_IMAGE:-registry.harbor.lan/library/mentatlab-frontend:latest}
          build: !reset null
      EOF

      # Start services
      echo "Starting services..."
      docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d

      # Wait for services to be healthy
      echo "Waiting for services to be healthy..."
      MAX_RETRIES=60
      for i in $(seq 1 $MAX_RETRIES); do
        ORCH_HEALTH=$(curl -sf http://localhost:7070/healthz 2>/dev/null && echo "ok" || echo "fail")
        GW_HEALTH=$(curl -sf http://localhost:8080/healthz 2>/dev/null && echo "ok" || echo "fail")
        FE_HEALTH=$(curl -sf http://localhost:5173 2>/dev/null && echo "ok" || echo "fail")

        if [ "$ORCH_HEALTH" = "ok" ] && [ "$GW_HEALTH" = "ok" ] && [ "$FE_HEALTH" = "ok" ]; then
          echo "All services healthy!"
          break
        fi

        echo "[$i/$MAX_RETRIES] Waiting... (orch=$ORCH_HEALTH, gw=$GW_HEALTH, fe=$FE_HEALTH)"
        sleep 2
      done

      # Run E2E tests
      echo "=== Running E2E Tests ==="

      # Test 1: Health endpoints
      echo "Test 1: Health endpoints..."
      curl -sf http://localhost:7070/healthz || (echo "FAIL: Orchestrator health" && exit 1)
      curl -sf http://localhost:8080/healthz || (echo "FAIL: Gateway health" && exit 1)
      echo "PASS: Health endpoints"

      # Test 2: API endpoints are reachable
      echo "Test 2: API endpoints..."
      curl -sf http://localhost:7070/api/v1/runs || (echo "FAIL: Runs endpoint" && exit 1)
      curl -sf http://localhost:7070/api/v1/agents || (echo "FAIL: Agents endpoint" && exit 1)
      echo "PASS: API endpoints"

      # Test 3: Gateway proxies to orchestrator
      echo "Test 3: Gateway proxy..."
      curl -sf http://localhost:8080/api/v1/runs || (echo "FAIL: Gateway proxy" && exit 1)
      echo "PASS: Gateway proxy"

      # Test 4: Frontend loads
      echo "Test 4: Frontend..."
      curl -sf http://localhost:5173 | grep -q "<!DOCTYPE html>" || (echo "FAIL: Frontend" && exit 1)
      echo "PASS: Frontend"

      echo "=== All E2E Tests Passed ==="
  after_script:
    - docker-compose -f docker-compose.yml -f docker-compose.ci.yml logs --tail=100 || true
    - docker-compose -f docker-compose.yml -f docker-compose.ci.yml down -v || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # E2E tests are advisory initially

deploy:
  stage: deploy
  image: alpine:3.21
  script:
    - echo "Images are built/pushed by the build stage (or via ./build-and-push.sh)."
    - echo "Apply/update Kubernetes manifests via GitOps (platform/gitops) or mentatlab/k8s."
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
