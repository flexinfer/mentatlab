include:
  - project: platform/gitops
    ref: main
    file:
      - /k3s/ci/caches/gitlab-ci-cache.yml

stages:
  - lint
  - test
  - build

variables:
  REGISTRY: registry.harbor.lan/library
  BUILDKIT_HOST: "tcp://buildkitd-central.ci-build.svc.cluster.local:1234"

# --- Linting ---

lint-go:
  stage: lint
  image: golang:1.24-alpine
  script:
    - (cd services/gateway-go && go vet ./...)
    - (cd services/orchestrator-go && go vet ./...)

lint-frontend:
  stage: lint
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm run lint

# --- Testing ---

test-go:
  stage: test
  image: golang:1.24-alpine
  script:
    - (cd services/gateway-go && go test -v ./...)
    - (cd services/orchestrator-go && go test -v ./...)

test-frontend:
  stage: test
  image: node:20-alpine
  script:
    - cd services/frontend
    - npm ci
    - npm test

# --- Build ---

# Build images via BuildKit (no Docker-in-Docker)
build-images:
  stage: build
  image: moby/buildkit:v0.12.5
  script:
    - |
      echo "Waiting for BuildKit..."
      for i in $(seq 1 30); do
        if buildctl --addr "${BUILDKIT_HOST}" debug info >/dev/null 2>&1; then
          echo "BuildKit is ready"; break
        fi
        echo "[$i/30] not ready yet"; sleep 2
      done
      buildctl --addr "${BUILDKIT_HOST}" debug info
    - |
      REGISTRY_TARGET="${REGISTRY}"
      build_image() {
        local name="$1" context="$2"
        buildctl --addr "${BUILDKIT_HOST}" build \
          --frontend dockerfile.v0 \
          --local context="${context}" \
          --local dockerfile="${context}" \
          --opt platform=linux/amd64 \
          --output "type=image,name=${REGISTRY_TARGET}/${name}:latest,${REGISTRY_TARGET}/${name}:${CI_COMMIT_SHORT_SHA},push=true"
      }

      build_image "mentatlab-orchestrator-go" "services/orchestrator-go"
      build_image "mentatlab-gateway-go" "services/gateway-go"
      build_image "mentatlab-frontend" "services/frontend"
      build_image "mentatlab-echoagent" "services/agents/echo"
      build_image "mentatlab-psyche-sim" "agents/psyche-sim"
      build_image "mentatlab-ctm-cogpack" "agents/ctm-cogpack"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
